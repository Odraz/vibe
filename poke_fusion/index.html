<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PokÃ©Fusion - A Daily PokÃ©mon Puzzle</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Press+Start+2P&family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
        }
        .font-pokemon {
            font-family: 'Press Start 2P', cursive;
        }
        .pokeball-loader {
            width: 50px;
            height: 50px;
            border-radius: 50%;
            background: linear-gradient(to bottom, #f00 50%, #fff 50%);
            border: 3px solid #000;
            position: relative;
            animation: spin 1s linear infinite;
        }
        .pokeball-loader::before {
            content: '';
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            width: 15px;
            height: 15px;
            background: #fff;
            border: 3px solid #000;
            border-radius: 50%;
        }
        .pokeball-loader::after {
            content: '';
            position: absolute;
            top: 50%;
            left: 0;
            right: 0;
            height: 3px;
            background: #000;
            transform: translateY(-50%);
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        .autocomplete-suggestions {
            border: 1px solid #ddd;
            max-height: 150px;
            overflow-y: auto;
            position: absolute;
            z-index: 1000;
            width: 100%;
        }
        .autocomplete-suggestion {
            padding: 8px;
            cursor: pointer;
        }
        .autocomplete-suggestion:hover {
            background-color: #f0f0f0;
        }
        .guess-row {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 10px;
        }
        .guess-box {
            border: 2px solid #d1d5db;
            height: 60px;
            display: flex;
            justify-content: center;
            align-items: center;
            font-weight: bold;
            text-transform: capitalize;
            transition: all 0.5s ease;
        }
        .guess-box.red {
            background-color: #ef4444; /* red-500 */
            color: white;
            border-color: #dc2626; /* red-600 */
        }
        .guess-box.green {
            background-color: #22c55e; /* green-500 */
            color: white;
            border-color: #16a34a; /* green-600 */
        }
        /* Flip animation */
        .flip {
            animation: flip 0.6s ease;
        }
        @keyframes flip {
            0% { transform: rotateX(0deg); }
            50% { transform: rotateX(90deg); }
            100% { transform: rotateX(0deg); }
        }
    </style>
</head>
<body class="bg-gray-100 text-gray-800 flex flex-col items-center justify-center min-h-screen p-4">

    <div id="loader" class="flex flex-col items-center justify-center text-center">
        <div class="pokeball-loader"></div>
        <p id="loader-text" class="mt-4 text-lg font-semibold">Loading Daily PokÃ©Fusion...</p>
    </div>

    <main id="game-container" class="hidden w-full max-w-md mx-auto">
        <header class="text-center mb-4">
            <h1 class="text-4xl font-pokemon text-yellow-500" style="text-shadow: 2px 2px #3B82F6;">PokÃ©Fusion</h1>
            <p class="text-gray-600">Guess the two PokÃ©mon that were fused!</p>
            <p class="text-sm text-gray-500">Puzzle for <span id="puzzle-date"></span></p>
        </header>

        <!-- API Key Input -->
        <div id="api-key-container" class="mb-4 p-4 bg-yellow-100 border border-yellow-300 rounded-lg">
             <label for="api-key" class="block text-sm font-medium text-yellow-800 mb-1">Enter your Gemini API Key to play:</label>
             <input type="password" id="api-key" class="w-full px-3 py-2 border border-yellow-400 rounded-md focus:outline-none focus:ring-2 focus:ring-yellow-500" placeholder="Your Gemini API Key">
             <button id="save-key" class="mt-2 w-full px-4 py-2 bg-yellow-500 text-white rounded-md font-bold hover:bg-yellow-600 transition">Start Game</button>
             <p class="text-xs text-yellow-700 mt-2">You can get a key from <a href="https://ai.google.dev/" target="_blank" class="underline">Google AI Studio</a>. Your key is saved in your browser.</p>
        </div>


        <!-- Fusion Image -->
        <div id="fusion-image-container" class="relative w-48 h-48 mx-auto mb-4 bg-white rounded-lg shadow-inner flex items-center justify-center overflow-hidden hidden">
            <img id="fusion-image" class="w-40 h-40 object-contain" src="" alt="Fused PokÃ©mon">
        </div>

        <!-- Guess Grid -->
        <div id="guess-grid" class="space-y-2 mb-4">
            <!-- Rows will be generated by JS -->
        </div>

        <!-- Hint Area -->
        <div id="hint-area" class="text-center my-2 text-blue-600 font-semibold hidden h-6"></div>

        <!-- Input Area -->
        <div id="input-area" class="flex items-center space-x-2 relative">
            <div class="w-1/2 relative">
                <input type="text" id="guess1" placeholder="PokÃ©mon 1" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500 disabled:bg-gray-200 disabled:cursor-not-allowed" autocomplete="off">
                 <div id="autocomplete1" class="autocomplete-suggestions bg-white rounded-md shadow-lg hidden"></div>
            </div>
            <div class="w-1/2 relative">
                 <input type="text" id="guess2" placeholder="PokÃ©mon 2" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500 disabled:bg-gray-200 disabled:cursor-not-allowed" autocomplete="off">
                 <div id="autocomplete2" class="autocomplete-suggestions bg-white rounded-md shadow-lg hidden"></div>
            </div>
            <button id="submit-guess" class="px-4 py-2 bg-blue-500 text-white rounded-md font-bold hover:bg-blue-600 transition disabled:bg-gray-400">Guess</button>
        </div>

        <div id="toast" class="fixed bottom-10 left-1/2 -translate-x-1/2 bg-gray-800 text-white px-4 py-2 rounded-md shadow-lg hidden transition-opacity duration-300">
            Invalid PokÃ©mon selection!
        </div>

    </main>

    <!-- Results Modal -->
    <div id="results-modal" class="hidden fixed inset-0 bg-gray-900 bg-opacity-75 flex items-center justify-center p-4 z-50">
        <div class="bg-white rounded-lg shadow-2xl p-6 w-full max-w-md text-center">
            <h2 id="modal-title" class="text-2xl font-bold mb-2"></h2>
            <p class="text-gray-600 mb-4">The correct PokÃ©mon were:</p>
            <div class="flex justify-center items-center space-x-4 mb-4">
                <div class="text-center">
                    <img id="result-img1" class="w-24 h-24 mx-auto" src="">
                    <p id="result-name1" class="font-bold capitalize"></p>
                </div>
                <span class="text-2xl font-bold">+</span>
                <div class="text-center">
                    <img id="result-img2" class="w-24 h-24 mx-auto" src="">
                    <p id="result-name2" class="font-bold capitalize"></p>
                </div>
            </div>
            <div class="my-4">
                <img id="modal-fused-image" class="w-32 h-32 mx-auto object-contain bg-white rounded-lg" src="" alt="Final Fused PokÃ©mon">
            </div>
            <p class="mb-4">They fused to become... <b id="fused-name" class="text-xl text-blue-600"></b>!</p>
            
            <div id="results-history" class="text-sm mb-4"></div>

            <div class="bg-gray-100 p-4 rounded-lg mb-4">
                <h3 class="font-bold text-lg mb-2">Your Stats</h3>
                <div class="grid grid-cols-2 md:grid-cols-4 gap-2 text-center">
                    <div>
                        <p id="stat-played" class="text-2xl font-bold">0</p>
                        <p class="text-xs text-gray-600">Played</p>
                    </div>
                    <div>
                        <p id="stat-win-pct" class="text-2xl font-bold">0</p>
                        <p class="text-xs text-gray-600">Win %</p>
                    </div>
                    <div>
                        <p id="stat-current-streak" class="text-2xl font-bold">0</p>
                        <p class="text-xs text-gray-600">Current Streak</p>
                    </div>
                    <div>
                        <p id="stat-max-streak" class="text-2xl font-bold">0</p>
                        <p class="text-xs text-gray-600">Max Streak</p>
                    </div>
                </div>
                 <h4 class="font-bold text-md mt-4 mb-2">Guess Distribution</h4>
                 <div id="guess-distribution" class="space-y-1 text-xs"></div>
            </div>

            <button id="share-button" class="w-full bg-green-500 text-white font-bold py-3 rounded-lg hover:bg-green-600 transition-all flex items-center justify-center space-x-2">
                <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-share-fill" viewBox="0 0 16 16">
                    <path d="M11 2.5a2.5 2.5 0 1 1 .603 1.628l-6.718 3.12a2.499 2.499 0 0 1 0 1.504l6.718 3.12a2.5 2.5 0 1 1-.488.876l-6.718-3.12a2.5 2.5 0 1 1 0-3.256l6.718-3.12A2.5 2.5 0 0 1 11 2.5z"/>
                </svg>
                <span>Share My Result</span>
            </button>
        </div>
    </div>


    <script>
        document.addEventListener('DOMContentLoaded', () => {
            const POKE_API_BASE = 'https://pokeapi.co/api/v2/';
            const MAX_POKEMON_ID = 151;
            const MAX_GUESSES = 6;
            let GEMINI_API_KEY = '';

            // --- STATE MANAGEMENT ---
            let allPokemon = [];
            let dailyPokemon = { p1: null, p2: null };
            let dailyFusedName = '';
            let guesses = [];
            let correctGuesses = new Set();
            let currentGuess = 0;
            let gameOver = false;

            // --- UI ELEMENTS ---
            const loader = document.getElementById('loader');
            const loaderText = document.getElementById('loader-text');
            const gameContainer = document.getElementById('game-container');
            const apiKeyContainer = document.getElementById('api-key-container');
            const apiKeyInput = document.getElementById('api-key');
            const saveKeyButton = document.getElementById('save-key');
            const fusionImageContainer = document.getElementById('fusion-image-container');
            const fusionImage = document.getElementById('fusion-image');

            const guessGrid = document.getElementById('guess-grid');
            const guessInput1 = document.getElementById('guess1');
            const guessInput2 = document.getElementById('guess2');
            const autocomplete1 = document.getElementById('autocomplete1');
            const autocomplete2 = document.getElementById('autocomplete2');
            const submitButton = document.getElementById('submit-guess');
            const hintArea = document.getElementById('hint-area');
            const toast = document.getElementById('toast');
            
            const modal = document.getElementById('results-modal');
            const modalTitle = document.getElementById('modal-title');
            const resultImg1 = document.getElementById('result-img1');
            const resultName1 = document.getElementById('result-name1');
            const resultImg2 = document.getElementById('result-img2');
            const resultName2 = document.getElementById('result-name2');
            const fusedNameEl = document.getElementById('fused-name');
            const shareButton = document.getElementById('share-button');
            const modalFusedImage = document.getElementById('modal-fused-image');

            // --- Game Initialization ---
            async function initGame() {
                GEMINI_API_KEY = localStorage.getItem('gemini_api_key');
                if (!GEMINI_API_KEY) {
                    loader.classList.add('hidden');
                    gameContainer.classList.remove('hidden');
                    apiKeyContainer.classList.remove('hidden');
                    fusionImageContainer.classList.add('hidden');
                    return;
                }
                
                apiKeyContainer.classList.add('hidden');
                loader.classList.remove('hidden');
                
                try {
                    await fetchAllPokemon();
                    await setupDailyPuzzle();
                    loadGameState();
                    renderGuessGrid();
                    
                    if (gameOver) {
                        const lastGuess = guesses[guesses.length - 1];
                        const win = lastGuess && lastGuess.p1.status === 'green' && lastGuess.p2.status === 'green';
                        showResults(win);
                    } else {
                        updateInputFields();
                    }
                    
                    setupAutocomplete();
                    loader.classList.add('hidden');
                    gameContainer.classList.remove('hidden');
                    fusionImageContainer.classList.remove('hidden');

                } catch (error) {
                    console.error("Failed to initialize game:", error);
                    loaderText.textContent = 'Error: ' + error.message;
                    loaderText.classList.add('text-red-500');
                }
            }

            saveKeyButton.addEventListener('click', () => {
                const key = apiKeyInput.value.trim();
                if (key) {
                    localStorage.setItem('gemini_api_key', key);
                    initGame();
                } else {
                    showToast("Please enter a valid API key.");
                }
            });

            async function fetchAllPokemon() {
                const storedPokemon = localStorage.getItem('allPokemon');
                if (storedPokemon) {
                    allPokemon = JSON.parse(storedPokemon);
                    return;
                }
                const response = await fetch(`${POKE_API_BASE}pokemon?limit=${MAX_POKEMON_ID}`);
                const data = await response.json();
                allPokemon = data.results.map((p, i) => ({ name: p.name, id: i + 1 }));
                localStorage.setItem('allPokemon', JSON.stringify(allPokemon));
            }

            async function setupDailyPuzzle() {
                const seed = getDailySeed();
                document.getElementById('puzzle-date').textContent = new Date(seed).toLocaleString(undefined, { year: 'numeric', month: 'long', day: 'numeric' });

                const cachedPuzzle = JSON.parse(localStorage.getItem('daily_puzzle'));
                if(cachedPuzzle && cachedPuzzle.seed === seed) {
                    dailyPokemon = cachedPuzzle.parents;
                    dailyFusedName = cachedPuzzle.fusedName;
                    fusionImage.src = cachedPuzzle.fusedImage;
                    return;
                }

                loaderText.textContent = "Selecting today's PokÃ©mon...";

                const p1Id = (seed % MAX_POKEMON_ID) + 1;
                let p2Id = ((seed * 17) % MAX_POKEMON_ID) + 1;
                while (p2Id === p1Id) {
                    p2Id = ((p2Id + 1) % MAX_POKEMON_ID) + 1;
                }

                const [p1Details, p2Details] = await Promise.all([
                    fetchPokemonDetails(p1Id),
                    fetchPokemonDetails(p2Id)
                ]);
                
                dailyPokemon = { p1: p1Details, p2: p2Details };

                loaderText.textContent = "Generating Fused Name with Gemini...";
                dailyFusedName = await generateFusedName(p1Details.name, p2Details.name);

                loaderText.textContent = "Generating Fused Image with Gemini...";
                const [p1ImageB64, p2ImageB64] = await Promise.all([
                    imageUrlToBase64(p1Details.sprite),
                    imageUrlToBase64(p2Details.sprite),
                ]);

                const fusedImageB64 = await generateFusedImage(p1ImageB64, p2ImageB64);
                fusionImage.src = `data:image/png;base64,${fusedImageB64}`;

                const puzzleToCache = {
                    seed,
                    parents: dailyPokemon,
                    fusedName: dailyFusedName,
                    fusedImage: fusionImage.src
                };
                localStorage.setItem('daily_puzzle', JSON.stringify(puzzleToCache));
            }

            // --- Gemini API Functions ---

            async function generateFusedName(name1, name2) {
                const API_URL = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-image-preview:generateContent?key=${GEMINI_API_KEY}`;
                const payload = {
                    contents: [{
                        parts: [{ text: `Create a clever, single-word name for a creature that is a fusion of a "${name1}" and a "${name2}". Only return the new name, nothing else.` }]
                    }],
                };

                try {
                    const response = await fetch(API_URL, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(payload)
                    });
                    if (!response.ok) {
                        throw new Error(`API Error: ${response.statusText}`);
                    }
                    const result = await response.json();
                    return result.candidates[0].content.parts[0].text.trim().replace(/["'.]/g, '');
                } catch (error) {
                    console.error("Gemini name generation failed:", error);
                    // Fallback to simple concatenation
                    return name1.slice(0, Math.ceil(name1.length / 2)) + name2.slice(Math.floor(name2.length / 2));
                }
            }
            
            async function generateFusedImage(base64Img1, base64Img2) {
                const API_URL = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-image-preview:generateContent?key=${GEMINI_API_KEY}`;
                const payload = {
                    contents: [{
                        parts: [
                            { text: "Fuse these two pokemon sprites into a single, cohesive hybrid creature on a clean white background. The new creature should blend features from both parents naturally. The style should match the pixel-art sprite style of the originals." },
                            { inlineData: { mimeType: "image/png", data: base64Img1 } },
                            { inlineData: { mimeType: "image/png", data: base64Img2 } }
                        ]
                    }],
                     generationConfig: {
                      responseModalities: ['TEXT', 'IMAGE']
                  },
                };
                 try {
                    const response = await fetch(API_URL, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(payload)
                    });
                     if (!response.ok) {
                        const errorBody = await response.text();
                        throw new Error(`API Error: ${response.statusText} - ${errorBody}`);
                    }
                    const result = await response.json();
                    const imagePart = result.candidates[0].content.parts.find(p => p.inlineData);
                    if (!imagePart) throw new Error("No image data in API response.");
                    return imagePart.inlineData.data;
                } catch (error) {
                     console.error("Gemini image generation failed:", error);
                     throw new Error("Failed to generate fused image. Check API key and console.");
                }
            }

            const imageUrlToBase64 = async (url) => {
                const response = await fetch(url);
                const blob = await response.blob();
                return new Promise((resolve, reject) => {
                    const reader = new FileReader();
                    reader.onloadend = () => resolve(reader.result.split(',')[1]);
                    reader.onerror = reject;
                    reader.readAsDataURL(blob);
                });
            };


            function getDailySeed() {
                const now = new Date();
                return new Date(now.getFullYear(), now.getMonth(), now.getDate()).getTime();
            }

            async function fetchPokemonDetails(id) {
                const response = await fetch(`${POKE_API_BASE}pokemon/${id}`);
                const data = await response.json();
                return {
                    id: data.id,
                    name: data.name,
                    sprite: data.sprites.front_default,
                    types: data.types.map(t => t.type.name),
                };
            }
            
            function loadGameState() {
                const savedState = JSON.parse(localStorage.getItem('pokefusion_gamestate'));
                const todaySeed = getDailySeed().toString();

                if (savedState && savedState.date === todaySeed) {
                    guesses = savedState.guesses || [];
                    currentGuess = guesses.length;
                    gameOver = savedState.gameOver || false;
                    correctGuesses = new Set(savedState.correctGuesses || []);
                } else {
                    // New day, reset state
                    localStorage.removeItem('pokefusion_gamestate');
                    guesses = [];
                    currentGuess = 0;
                    gameOver = false;
                    correctGuesses = new Set();
                }
            }
            
            function saveGameState() {
                 const state = {
                    date: getDailySeed().toString(),
                    guesses: guesses,
                    gameOver: gameOver,
                    correctGuesses: Array.from(correctGuesses)
                };
                localStorage.setItem('pokefusion_gamestate', JSON.stringify(state));
            }

            // --- UI & Rendering ---
            function renderGuessGrid() {
                guessGrid.innerHTML = '';
                for (let i = 0; i < MAX_GUESSES; i++) {
                    const row = document.createElement('div');
                    row.className = 'guess-row';
                    const guess = guesses[i];
                    
                    const guessBox1 = createGuessBox(guess ? guess.p1.name : '', guess ? guess.p1.status : '');
                    const guessBox2 = createGuessBox(guess ? guess.p2.name : '', guess ? guess.p2.status : '');
                    
                    if (i < currentGuess) {
                        guessBox1.classList.add('flip');
                        guessBox2.classList.add('flip');
                        guessBox1.style.animationDelay = '0.1s';
                        guessBox2.style.animationDelay = '0.3s';
                    }

                    row.appendChild(guessBox1);
                    row.appendChild(guessBox2);
                    guessGrid.appendChild(row);
                }
                updateHint();
            }

            function createGuessBox(text, status) {
                const box = document.createElement('div');
                box.className = 'guess-box rounded-md';
                box.textContent = text;
                if (status) {
                    box.classList.add(status);
                }
                return box;
            }

            function updateHint() {
                if (currentGuess >= 3 && !gameOver) {
                    const hintType = Math.random() < 0.5 ? dailyPokemon.p1.types[0] : dailyPokemon.p2.types[0];
                    hintArea.textContent = `Hint: One of the parent PokÃ©mon is a '${hintType.toUpperCase()}' type.`;
                    hintArea.classList.remove('hidden');
                }
            }

            function updateInputFields() {
                const correctGuessedList = Array.from(correctGuesses);
                
                guessInput1.value = '';
                guessInput1.disabled = false;
                guessInput2.value = '';
                guessInput2.disabled = false;
                
                if (correctGuessedList.length === 1) {
                    guessInput1.value = correctGuessedList[0];
                    guessInput1.disabled = true;
                    guessInput2.focus();
                } else if (correctGuessedList.length >= 2) {
                    guessInput1.value = correctGuessedList[0];
                    guessInput1.disabled = true;
                    guessInput2.value = correctGuessedList[1];
                    guessInput2.disabled = true;
                }
            }

            // --- Autocomplete Logic ---
            function setupAutocomplete() {
                guessInput1.addEventListener('input', () => showSuggestions(guessInput1, autocomplete1));
                guessInput2.addEventListener('input', () => showSuggestions(guessInput2, autocomplete2));
                
                document.addEventListener('click', (e) => {
                    if (!e.target.closest('.relative')) {
                        autocomplete1.classList.add('hidden');
                        autocomplete2.classList.add('hidden');
                    }
                });
            }

            function showSuggestions(input, container) {
                const value = input.value.toLowerCase();
                container.innerHTML = '';
                if (!value) {
                    container.classList.add('hidden');
                    return;
                }
                const suggestions = allPokemon
                    .filter(p => p.name.startsWith(value))
                    .slice(0, 5);

                if (suggestions.length > 0) {
                    suggestions.forEach(p => {
                        const div = document.createElement('div');
                        div.textContent = p.name;
                        div.className = 'autocomplete-suggestion';
                        div.onclick = () => {
                            input.value = p.name;
                            container.classList.add('hidden');
                        };
                        container.appendChild(div);
                    });
                    container.classList.remove('hidden');
                } else {
                    container.classList.add('hidden');
                }
            }

            // --- Guessing Logic ---
            submitButton.addEventListener('click', handleGuess);

            function handleGuess() {
                if (gameOver) return;

                const name1 = guessInput1.value.toLowerCase().trim();
                const name2 = guessInput2.value.toLowerCase().trim();

                if (!name1 || !name2) {
                    showToast('Please select two PokÃ©mon.');
                    return;
                }

                const pokemon1 = allPokemon.find(p => p.name === name1);
                const pokemon2 = allPokemon.find(p => p.name === name2);
                
                if (!pokemon1 || !pokemon2 || name1 === name2) {
                    showToast('Please select two different valid PokÃ©mon.');
                    return;
                }

                const guessResult = checkGuess(name1, name2);
                if (guessResult.p1.status === 'green') correctGuesses.add(name1);
                if (guessResult.p2.status === 'green') correctGuesses.add(name2);
                
                guesses.push(guessResult);
                currentGuess++;
                
                renderGuessGrid();
                saveGameState();
                
                updateInputFields();

                const isWin = guessResult.p1.status === 'green' && guessResult.p2.status === 'green';
                if (isWin) {
                    gameOver = true;
                    saveGameState();
                    setTimeout(() => showResults(true), 1000);
                } else if (currentGuess >= MAX_GUESSES) {
                    gameOver = true;
                    saveGameState();
                    setTimeout(() => showResults(false), 1000);
                }
            }

            function checkGuess(name1, name2) {
                const correctNames = [dailyPokemon.p1.name, dailyPokemon.p2.name];
                
                const getStatus = (name) => {
                    return correctNames.includes(name) ? 'green' : 'red';
                };

                return {
                    p1: { name: name1, status: getStatus(name1) },
                    p2: { name: name2, status: getStatus(name2) }
                };
            }

            // --- Modals and Toasts ---
            function showToast(message) {
                toast.textContent = message;
                toast.classList.remove('hidden');
                setTimeout(() => {
                    toast.classList.add('hidden');
                }, 3000);
            }

            function showResults(win) {
                if (!dailyPokemon.p1 || !dailyPokemon.p2) return;
                updateStats(win);

                modalTitle.textContent = win ? 'Congratulations!' : 'Better Luck Next Time!';
                resultImg1.src = dailyPokemon.p1.sprite;
                resultName1.textContent = dailyPokemon.p1.name;
                resultImg2.src = dailyPokemon.p2.sprite;
                resultName2.textContent = dailyPokemon.p2.name;
                fusedNameEl.textContent = dailyFusedName;
                modalFusedImage.src = fusionImage.src;
                
                generateResultsHistory();
                
                modal.classList.remove('hidden');
                
                if (win) {
                     document.getElementById('modal-title').classList.add('text-green-500');
                } else {
                     document.getElementById('modal-title').classList.add('text-red-500');
                }
            }

            function generateResultsHistory() {
                document.getElementById('results-history').innerHTML = guesses.map(g => {
                    const box1 = `<span class="inline-block w-4 h-4 rounded ${g.p1.status === 'green' ? 'bg-green-500' : 'bg-red-500'}"></span>`;
                    const box2 = `<span class="inline-block w-4 h-4 rounded ${g.p2.status === 'green' ? 'bg-green-500' : 'bg-red-500'}"></span>`;
                    return `<div>${box1} ${box2}</div>`;
                }).join('');
            }

            // --- Stats Management ---
            function getStats() {
                return JSON.parse(localStorage.getItem('pokefusion_stats')) || {
                    played: 0,
                    wins: 0,
                    currentStreak: 0,
                    maxStreak: 0,
                    guessDistribution: {1:0, 2:0, 3:0, 4:0, 5:0, 6:0},
                    lastWinDate: null,
                    lastGameProcessed: null
                };
            }
            
            function updateStats(win) {
                const stats = getStats();
                const todaySeed = getDailySeed().toString();

                // Prevent stats from being updated more than once per day
                if (stats.lastGameProcessed === todaySeed) {
                    displayStats(stats);
                    return;
                }

                stats.played++;
                
                const today = new Date();
                const yesterday = new Date();
                yesterday.setDate(today.getDate() - 1);

                if (win) {
                    stats.wins++;
                    stats.guessDistribution[currentGuess]++;
                    
                    const lastWin = stats.lastWinDate ? new Date(stats.lastWinDate) : null;
                    if (lastWin && lastWin.toDateString() === yesterday.toDateString()) {
                        stats.currentStreak++;
                    } else {
                        stats.currentStreak = 1;
                    }

                    if (stats.currentStreak > stats.maxStreak) {
                        stats.maxStreak = stats.currentStreak;
                    }
                    stats.lastWinDate = today.getTime();

                } else {
                    stats.currentStreak = 0;
                }
                
                stats.lastGameProcessed = todaySeed;
                localStorage.setItem('pokefusion_stats', JSON.stringify(stats));
                displayStats(stats);
            }
            
            function displayStats(stats) {
                document.getElementById('stat-played').textContent = stats.played;
                document.getElementById('stat-win-pct').textContent = stats.played > 0 ? Math.round((stats.wins / stats.played) * 100) : 0;
                document.getElementById('stat-current-streak').textContent = stats.currentStreak;
                document.getElementById('stat-max-streak').textContent = stats.maxStreak;
                
                const distContainer = document.getElementById('guess-distribution');
                distContainer.innerHTML = '';
                const maxVal = Math.max(...Object.values(stats.guessDistribution), 1);
                for(let i=1; i<=6; i++) {
                    const count = stats.guessDistribution[i] || 0;
                    const width = (count / maxVal * 100);
                    const bar = `
                    <div class="flex items-center">
                        <div class="w-4">${i}</div>
                        <div class="flex-grow bg-gray-200 rounded h-4 mr-2">
                          <div class="bg-blue-500 h-4 rounded text-white text-right pr-1" style="width: ${width > 0 ? width : 2}%">${count > 0 ? count : ''}</div>
                        </div>
                    </div>`;
                    distContainer.innerHTML += bar;
                }
            }

            // --- Sharing ---
            shareButton.addEventListener('click', () => {
                let resultText = `PokÃ©Fusion #${getPuzzleNumber()} - I guessed it in ${guesses.length}/6 tries!\n\n`;
                resultText += guesses.map(g => {
                    const r1 = g.p1.status === 'green' ? 'ðŸŸ©' : 'ðŸŸ¥';
                    const r2 = g.p2.status === 'green' ? 'ðŸŸ©' : 'ðŸŸ¥';
                    return `${r1}${r2}`;
                }).join('\n');
                
                // Fallback for clipboard API
                try {
                    const textArea = document.createElement("textarea");
                    textArea.value = resultText;
                    document.body.appendChild(textArea);
                    textArea.focus();
                    textArea.select();
                    document.execCommand('copy');
                    document.body.removeChild(textArea);
                    showToast('Results copied to clipboard!');
                    shareButton.innerHTML = `
                     <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-check-lg" viewBox="0 0 16 16"><path d="M12.736 3.97a.733.733 0 0 1 1.047 0c.286.289.29.756.01 1.05L7.88 12.01a.733.733 0 0 1-1.065.02L3.217 8.384a.757.757 0 0 1 0-1.06.733.733 0 0 1 1.047 0l3.052 3.093 5.4-6.425a.247.247 0 0 1 .02-.022Z"/></svg>
                    <span>Copied!</span>`;
                } catch (err) {
                    console.error('Failed to copy text: ', err);
                     showToast('Could not copy results.');
                }
            });
            
            function getPuzzleNumber() {
                const startDate = new Date(2024, 0, 1); // An arbitrary start date
                const today = new Date();
                const diffTime = Math.abs(today - startDate);
                return Math.ceil(diffTime / (1000 * 60 * 60 * 24));
            }

            // --- Start the game ---
            initGame();
        });
    </script>
</body>
</html>

